name: Automatic Release

on:
  push:
    branches:
      - main  # Feuert bei jedem Push auf Main
  workflow_dispatch: # Erlaubt manuelles Starten

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Wichtig f체r Releases
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Version Number
        id: version
        run: |
          # Wir bauen eine Version aus einer Basisnummer und der GitHub Run Number
          # Das garantiert, dass die Nummer immer steigt (wichtig f체r HACS Updates)
          # Beispiel Ergebnis: v0.1.45
          
          MAJOR_MINOR="0.1"
          RUN_NUMBER="${{ github.run_number }}"
          
          VERSION="v${MAJOR_MINOR}.${RUN_NUMBER}"
          CLEAN_VERSION="${MAJOR_MINOR}.${RUN_NUMBER}"
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "CLEAN_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
          
          echo "Generierte Version: $VERSION"

      - name: Update manifest.json (Temporary for Zip)
        run: |
          # Version in der manifest.json f체r das ZIP Paket setzen
          jq --arg ver "${{ env.CLEAN_VERSION }}" '.version = $ver' custom_components/compleo_wallbox/manifest.json > manifest.tmp && mv manifest.tmp custom_components/compleo_wallbox/manifest.json
          
          echo "Manifest Version tempor채r auf ${{ env.CLEAN_VERSION }} gesetzt."

      - name: Zip component directory
        run: |
          cd custom_components/compleo_wallbox
          zip -r ../../compleo_wallbox.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}     # Setzt den Tag automatisch (z.B. v0.1.45)
          name: Release ${{ env.VERSION }} # Titel des Releases
          files: compleo_wallbox.zip
          generate_release_notes: true     # Generiert automatisch Notizen aus den Commits
          draft: false
          prerelease: false